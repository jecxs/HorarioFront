<h2 mat-dialog-title>
  {{ data.mode === 'create' ? 'Nueva Asignación de Clase' : 'Editar Asignación' }}
</h2>

<mat-dialog-content class="dialog-content">
  <form [formGroup]="assignmentForm">

    <!-- Información del contexto -->
    <div class="context-info">
      <mat-chip-set>
        <mat-chip *ngIf="data.studentGroup">
          <mat-icon>groups</mat-icon>
          Grupo: {{ data.studentGroup.name }}
        </mat-chip>
        <mat-chip *ngIf="data.dayOfWeek">
          <mat-icon>today</mat-icon>
          {{ getDayName(data.dayOfWeek) }}
        </mat-chip>
        <mat-chip *ngIf="data.teachingHours && data.teachingHours.length > 0">
          <mat-icon>schedule</mat-icon>
          {{ formatTimeRange(data.teachingHours) }}
        </mat-chip>
      </mat-chip-set>
    </div>

    <!-- Step 1: Selección de Curso -->
    <mat-expansion-panel [expanded]="currentStep === 1" (opened)="currentStep = 1">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <span class="step-number">1</span>
          Seleccionar Curso
        </mat-panel-title>
        <mat-panel-description *ngIf="selectionState.course">
          {{ selectionState.course.name }}
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="step-content">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Curso</mat-label>
          <mat-select formControlName="courseUuid" (selectionChange)="onCourseSelected($event.value)">
            <mat-option>
              <ngx-mat-select-search
                [formControl]="courseFilterCtrl"
                placeholderLabel="Buscar curso..."
                noEntriesFoundLabel="No se encontraron cursos">
              </ngx-mat-select-search>
            </mat-option>
            <mat-option *ngFor="let course of filteredCourses$ | async" [value]="course.uuid">
              <div class="option-content">
                <span class="option-main">{{ course.name }}</span>
                <span class="option-secondary">{{ course.code }} - Ciclo {{ course.cycle.number }}</span>
              </div>
            </mat-option>
          </mat-select>
          <mat-hint *ngIf="loadingCourses">Cargando cursos...</mat-hint>
        </mat-form-field>

        <!-- IntelliSense para curso -->
        <div class="intellisense-panel" *ngIf="selectionState.course">
          <div class="course-details">
            <div class="detail-item">
              <mat-icon>access_time</mat-icon>
              <span>{{ selectionState.course.weeklyTheoryHours }}h teoría,
                {{ selectionState.course.weeklyPracticeHours }}h práctica</span>
            </div>
            <div class="detail-item">
              <mat-icon>psychology</mat-icon>
              <span>Área: {{ selectionState.course.teachingKnowledgeArea.name }}</span>
            </div>
            <div class="detail-item" *ngIf="selectionState.course.preferredSpecialty">
              <mat-icon>science</mat-icon>
              <span>Laboratorio preferido: {{ selectionState.course.preferredSpecialty.name }}</span>
            </div>
          </div>
        </div>
      </div>
    </mat-expansion-panel>

    <!-- Step 2: Selección de Docente -->
    <mat-expansion-panel [expanded]="currentStep === 2"
                         [disabled]="!selectionState.course"
                         (opened)="currentStep = 2">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <span class="step-number">2</span>
          Seleccionar Docente
        </mat-panel-title>
        <mat-panel-description *ngIf="selectionState.teacher">
          {{ selectionState.teacher.fullName }}
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="step-content">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Docente</mat-label>
          <mat-select formControlName="teacherUuid" (selectionChange)="onTeacherSelected($event.value)">
            <!-- ✅ Cambiar para usar eligibleTeachersDetailed -->
            <mat-option *ngFor="let teacher of eligibleTeachersDetailed"
                        [value]="teacher.uuid"
                        [disabled]="!teacher.isAvailableForTimeSlot">
              <div class="option-content">
                <div class="teacher-info">
                  <span class="option-main">{{ teacher.fullName }}</span>

                  <!-- ✅ Indicador de disponibilidad -->
                  <mat-chip [class]="getAvailabilityClass(teacher.availabilityStatus)">
                    {{ getAvailabilityText(teacher.availabilityStatus) }}
                  </mat-chip>
                </div>

                <!-- ✅ Mostrar horarios recomendados si no está disponible -->
                <div *ngIf="!teacher.isAvailableForTimeSlot && teacher.recommendedTimeSlots"
                     class="recommended-times">
                  <mat-icon>schedule</mat-icon>
                  Disponible: {{ teacher.recommendedTimeSlots }}
                </div>

                <div class="option-tags">
                  <mat-chip *ngFor="let area of teacher.knowledgeAreas"
                            [class.highlight]="isMatchingKnowledgeArea(area)">
                    {{ area.name }}
                  </mat-chip>
                </div>
              </div>
            </mat-option>
          </mat-select>
          <mat-hint *ngIf="loadingTeachers">
            <mat-spinner diameter="16"></mat-spinner>
            Buscando docentes disponibles...
          </mat-hint>
          <mat-hint *ngIf="!loadingTeachers && eligibleTeachersDetailed.length === 0">
            No hay docentes disponibles con el área de conocimiento requerida
          </mat-hint>
        </mat-form-field>


        <!-- Recomendaciones de docentes -->
        <div class="recommendations" *ngIf="(intelliSense?.recommendations?.length ?? 0) > 0">
          <h4>
            <mat-icon>lightbulb</mat-icon>
            Recomendaciones
          </h4>
          <mat-list>
            <mat-list-item *ngFor="let rec of (intelliSense?.recommendations ?? [])">
              <mat-icon matListItemIcon>check_circle</mat-icon>
              <span matListItemTitle>{{ rec }}</span>
            </mat-list-item>
          </mat-list>
        </div>
      </div>
    </mat-expansion-panel>

    <!-- Step 3: Selección de Aula -->
    <mat-expansion-panel [expanded]="currentStep === 3"
                         [disabled]="!selectionState.teacher"
                         (opened)="currentStep = 3">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <span class="step-number">3</span>
          Seleccionar Aula
        </mat-panel-title>
        <mat-panel-description *ngIf="selectionState.learningSpace">
          {{ selectionState.learningSpace.name }}
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="step-content">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Aula/Laboratorio</mat-label>
          <mat-select formControlName="learningSpaceUuid" (selectionChange)="onSpaceSelected($event.value)">
            <mat-optgroup *ngFor="let group of groupedSpaces" [label]="group.label">
              <mat-option *ngFor="let space of group.spaces" [value]="space.uuid">
                <div class="option-content">
                  <span class="option-main">{{ space.name }}</span>
                  <span class="option-secondary">
                        Capacidad: {{ space.capacity }} -
                    {{ space.teachingType.name === 'THEORY' ? 'Teórica' : 'Práctica' }}
                    <span *ngIf="space.specialty"> - {{ space.specialty.name }}</span>
                      </span>
                </div>
              </mat-option>
            </mat-optgroup>
          </mat-select>
          <mat-hint *ngIf="loadingSpaces">
            <mat-spinner diameter="16"></mat-spinner>
            Verificando disponibilidad de aulas...
          </mat-hint>
        </mat-form-field>
      </div>
    </mat-expansion-panel>

    <!-- Step 4: Confirmación y Validación -->
    <mat-expansion-panel [expanded]="currentStep === 4"
                         [disabled]="!selectionState.learningSpace"
                         (opened)="currentStep = 4">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <span class="step-number">4</span>
          Confirmar Asignación
        </mat-panel-title>
      </mat-expansion-panel-header>

      <div class="step-content">
        <!-- Resumen de la asignación -->
        <div class="assignment-summary">
          <h4>Resumen de la Asignación</h4>
          <mat-list>
            <mat-list-item>
              <mat-icon matListItemIcon>book</mat-icon>
              <span matListItemTitle>{{ selectionState.course?.name }}</span>
            </mat-list-item>
            <mat-list-item>
              <mat-icon matListItemIcon>person</mat-icon>
              <span matListItemTitle>{{ selectionState.teacher?.fullName }}</span>
            </mat-list-item>
            <mat-list-item>
              <mat-icon matListItemIcon>room</mat-icon>
              <span matListItemTitle>{{ selectionState.learningSpace?.name }}</span>
            </mat-list-item>
            <mat-list-item>
              <mat-icon matListItemIcon>schedule</mat-icon>
              <span matListItemTitle>{{ formatTimeRange(data.teachingHours || []) }}</span>
            </mat-list-item>
          </mat-list>
        </div>

        <!-- Notas adicionales -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Notas (Opcional)</mat-label>
          <textarea matInput
                    formControlName="notes"
                    rows="3"
                    placeholder="Agregar observaciones o notas sobre esta clase...">
              </textarea>
        </mat-form-field>

        <!-- Validación en tiempo real -->
        <div class="validation-panel" *ngIf="validationResult">
          <div class="validation-section" *ngIf="validationResult.errors.length > 0">
            <h4 class="error-title">
              <mat-icon>error</mat-icon>
              Errores
            </h4>
            <mat-list>
              <mat-list-item *ngFor="let error of validationResult.errors">
                <mat-icon matListItemIcon color="warn">cancel</mat-icon>
                <span matListItemTitle>{{ error }}</span>
              </mat-list-item>
            </mat-list>
          </div>

          <div class="validation-section" *ngIf="validationResult.warnings.length > 0">
            <h4 class="warning-title">
              <mat-icon>warning</mat-icon>
              Advertencias
            </h4>
            <mat-list>
              <mat-list-item *ngFor="let warning of validationResult.warnings">
                <mat-icon matListItemIcon color="accent">warning</mat-icon>
                <span matListItemTitle>{{ warning }}</span>
              </mat-list-item>
            </mat-list>
          </div>

          <div class="validation-section" *ngIf="validationResult.suggestions.length > 0">
            <h4 class="suggestion-title">
              <mat-icon>lightbulb</mat-icon>
              Sugerencias
            </h4>
            <mat-list>
              <mat-list-item *ngFor="let suggestion of validationResult.suggestions">
                <mat-icon matListItemIcon>tips_and_updates</mat-icon>
                <span matListItemTitle>{{ suggestion }}</span>
              </mat-list-item>
            </mat-list>
          </div>
        </div>
      </div>
    </mat-expansion-panel>

  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()">Cancelar</button>

  <button mat-raised-button
          color="primary"
          (click)="onSave()"
          [disabled]="!canSave">
    <mat-spinner diameter="20" *ngIf="saving"></mat-spinner>
    {{ saving ? 'Guardando...' : (data.mode === 'create' ? 'Crear' : 'Actualizar') }}
  </button>
</mat-dialog-actions>
