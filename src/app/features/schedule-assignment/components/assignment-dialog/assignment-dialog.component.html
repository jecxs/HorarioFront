<!-- assignment-dialog.component.html -->
<h2 mat-dialog-title>
  {{ data.mode === 'create' ? 'Nueva Asignación de Clase' : 'Editar Asignación' }}
</h2>

<mat-dialog-content class="dialog-content">
  <form [formGroup]="assignmentForm">

    <!-- Información del contexto -->
    <div class="context-info">
      <mat-chip-set>
        <mat-chip *ngIf="data.studentGroup">
          <mat-icon>groups</mat-icon>
          Grupo: {{ data.studentGroup.name }}
        </mat-chip>
        <mat-chip *ngIf="data.dayOfWeek">
          <mat-icon>today</mat-icon>
          {{ getDayName(data.dayOfWeek) }}
        </mat-chip>
        <mat-chip *ngIf="data.teachingHours && data.teachingHours.length > 0">
          <mat-icon>schedule</mat-icon>
          {{ formatTimeRange(data.teachingHours) }}
        </mat-chip>
      </mat-chip-set>
    </div>

    <!-- Step 1: Selección de Curso -->
    <mat-expansion-panel [expanded]="currentStep === 1" (opened)="currentStep = 1">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <span class="step-number">1</span>
          Seleccionar Curso
        </mat-panel-title>
        <mat-panel-description *ngIf="selectionState.course">
          {{ selectionState.course?.name }}
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="step-content">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Curso</mat-label>
          <mat-select formControlName="courseUuid" (selectionChange)="onCourseSelected($event.value)">
            <mat-option>
              <ngx-mat-select-search
                [formControl]="courseFilterCtrl"
                placeholderLabel="Buscar curso..."
                noEntriesFoundLabel="No se encontraron cursos">
              </ngx-mat-select-search>
            </mat-option>
            <mat-option *ngFor="let course of filteredCourses$ | async" [value]="course.uuid">
              <div class="option-content">
                <span class="option-main">{{ course.name }}</span>
                <span class="option-secondary">{{ course.code }} - Ciclo {{ course.cycle.number }}</span>
              </div>
            </mat-option>
          </mat-select>
          <mat-hint *ngIf="loadingCourses">Cargando cursos...</mat-hint>
        </mat-form-field>

        <!-- IntelliSense para curso -->
        <div class="intellisense-panel" *ngIf="selectionState.course">
          <div class="course-details">
            <div class="detail-item">
              <mat-icon>access_time</mat-icon>
              <span>{{ selectionState.course?.weeklyTheoryHours }}h teoría,
                {{ selectionState.course?.weeklyPracticeHours }}h práctica</span>
            </div>
            <div class="detail-item">
              <mat-icon>psychology</mat-icon>
              <span>Área: {{ selectionState.course?.teachingKnowledgeArea?.name }}</span>
            </div>
            <div class="detail-item" *ngIf="selectionState.course?.preferredSpecialty">
              <mat-icon>science</mat-icon>
              <span>Laboratorio preferido: {{ selectionState.course?.preferredSpecialty?.name }}</span>
            </div>
          </div>
        </div>
      </div>
    </mat-expansion-panel>

    <!-- ✅ Step 2: Selección de Tipo de Sesión -->
    <mat-expansion-panel [expanded]="currentStep === 2"
                         [disabled]="!selectionState.course"
                         (opened)="currentStep = 2">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <span class="step-number">2</span>
          Tipo de Sesión
        </mat-panel-title>
        <mat-panel-description *ngIf="selectionState.selectedSessionType">
          {{ selectionState.selectedSessionType === 'THEORY' ? 'Teórica' : 'Práctica' }}
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="step-content">
        <div class="session-type-selection">
          <h4 class="selection-title">
            <mat-icon>school</mat-icon>
            ¿Qué tipo de sesión desea asignar?
          </h4>
          <p class="selection-subtitle">
            Seleccione el tipo de clase según el contenido a impartir
          </p>

          <mat-radio-group
            formControlName="sessionType"
            (change)="onSessionTypeSelected($event.value)"
            class="session-type-options">

            <div *ngFor="let option of sessionTypeOptions"
                 class="session-type-option-container"
                 [class.disabled]="!option.isAvailable">

              <mat-radio-button
                [value]="option.value"
                [disabled]="!option.isAvailable"
                class="session-type-radio">

                <div class="option-card">
                  <div class="option-header">
                    <div class="option-icon">
                      <mat-icon [class]="option.value === 'THEORY' ? 'theory-icon' : 'practice-icon'">
                        {{ option.icon }}
                      </mat-icon>
                    </div>
                    <div class="option-info">
                      <h5 class="option-title">{{ option.label }}</h5>
                      <p class="option-description">{{ option.description }}</p>
                    </div>
                  </div>

                  <div class="option-stats">
                    <div class="stat-item">
                      <span class="stat-label">Horas semanales:</span>
                      <span class="stat-value">{{ option.weeklyHours }}h</span>
                    </div>
                    <div class="stat-item">
                      <span class="stat-label">Asignadas:</span>
                      <span class="stat-value"
                            [class.over-limit]="option.assignedHours > option.weeklyHours">
                        {{ option.assignedHours }}h
                      </span>
                    </div>
                  </div>

                  <div class="option-recommendation" *ngIf="option.recommendation">
                    <mat-icon class="recommendation-icon"
                              [class]="option.isAvailable ? 'available' : 'warning'">
                      {{ option.isAvailable ? 'check_circle' : 'warning' }}
                    </mat-icon>
                    <span class="recommendation-text">{{ option.recommendation }}</span>
                  </div>
                </div>
              </mat-radio-button>
            </div>
          </mat-radio-group>

          <!-- Información adicional -->
          <div class="type-selection-info" *ngIf="sessionTypeOptions.length > 0">
            <mat-icon>info</mat-icon>
            <div class="info-content">
              <p><strong>Teoría:</strong> Clases magistrales, explicaciones conceptuales, evaluaciones escritas.</p>
              <p><strong>Práctica:</strong> Laboratorios, talleres, trabajos prácticos, demostraciones.</p>
            </div>
          </div>

          <!-- Advertencia si no hay opciones disponibles -->
          <div class="no-options-warning" *ngIf="sessionTypeOptions.length === 0">
            <mat-icon>warning</mat-icon>
            <div class="warning-content">
              <h5>No hay tipos de sesión disponibles</h5>
              <p>Este curso no tiene horas teóricas ni prácticas definidas. Verifique la configuración del curso.</p>
            </div>
          </div>
        </div>
      </div>
    </mat-expansion-panel>

    <!-- Step 3: Selección de Docente -->
    <!-- Step 3: Selección de Docente Mejorada -->
    <mat-expansion-panel [expanded]="currentStep === 3"
                         [disabled]="!selectionState.selectedSessionType"
                         (opened)="currentStep = 3">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <span class="step-number">3</span>
          Seleccionar Docente
        </mat-panel-title>
        <mat-panel-description *ngIf="selectionState.teacher">
          {{ selectionState.teacher?.fullName }}
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="step-content">
        <!-- Loading State -->
        <div *ngIf="loadingTeachers" class="loading-container">
          <mat-spinner diameter="24"></mat-spinner>
          <span class="ml-3 text-slate-600">Verificando disponibilidad y conflictos de docentes...</span>
        </div>

        <!-- ✅ NUEVA UI: Categorías de Docentes -->
        <div *ngIf="!loadingTeachers" class="teacher-categories-container">

          <!-- Header con estadísticas -->
          <div class="categories-header">
            <div class="flex items-center space-x-4 mb-4">
              <div class="flex items-center space-x-2">
                <mat-icon class="text-slate-600">groups</mat-icon>
                <span class="font-medium text-slate-800">Docentes Elegibles</span>
              </div>
              <div class="flex items-center space-x-4 text-sm text-slate-600">
            <span class="flex items-center">
              <div class="w-3 h-3 rounded-full bg-green-500 mr-1"></div>
              {{ groupedTeachers.available.length }} disponibles
            </span>
                <span class="flex items-center">
              <div class="w-3 h-3 rounded-full bg-orange-500 mr-1"></div>
                  {{ groupedTeachers.withConflicts.length }} con conflictos
            </span>
                <span class="flex items-center">
              <div class="w-3 h-3 rounded-full bg-slate-400 mr-1"></div>
                  {{ groupedTeachers.unavailable.length + groupedTeachers.noSchedule.length }} no disponibles
            </span>
              </div>
            </div>
          </div>

          <!-- ✅ CATEGORÍA 1: Docentes Disponibles -->
          <div *ngIf="groupedTeachers.available.length > 0" class="teacher-category available-category">
            <div class="category-header">
              <div class="flex items-center space-x-2">
                <mat-icon class="text-green-600">check_circle</mat-icon>
                <h4 class="font-medium text-green-800">Disponibles ({{ groupedTeachers.available.length }})</h4>
              </div>
              <p class="text-sm text-green-600 mt-1">{{ getCategoryHelpText('available') }}</p>
            </div>

            <div class="teacher-cards-grid">
              <div *ngFor="let teacher of groupedTeachers.available"
                   class="teacher-card available-card"
                   (click)="onTeacherSelectedWithConflictCheck(teacher.uuid)">

                <div class="card-header">
                  <div class="teacher-info">
                    <h5 class="teacher-name">{{ teacher.fullName }}</h5>
                    <p class="teacher-email">{{ teacher.email }}</p>
                  </div>
                  <div class="status-badge available-badge">
                    <mat-icon>check_circle</mat-icon>
                    <span>Disponible</span>
                  </div>
                </div>

                <div class="card-content">
                  <div class="knowledge-areas">
                    <div class="area-tags">
                  <span *ngFor="let area of teacher.knowledgeAreas; let last = last"
                        class="area-tag"
                        [class.highlight]="isMatchingKnowledgeArea(area)">
                    {{ area.name }}{{ !last ? ',' : '' }}
                  </span>
                    </div>
                  </div>

                  <div *ngIf="teacher.recommendedTimeSlots" class="availability-info">
                    <mat-icon class="text-green-600">schedule</mat-icon>
                    <span>Horario: {{ teacher.recommendedTimeSlots }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ✅ CATEGORÍA 2: Docentes con Conflictos -->
          <!-- ✅ REEMPLAZAR la sección de docentes con conflictos -->
          <div *ngIf="groupedTeachers.withConflicts.length > 0" class="teacher-category conflict-category">
            <div class="category-header">
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                  <mat-icon class="text-orange-600">warning</mat-icon>
                  <h4 class="font-medium text-orange-800">Con Conflictos de Horario ({{ groupedTeachers.withConflicts.length }})</h4>
                </div>
                <button mat-icon-button
                        (click)="toggleConflictDetails()"
                        class="toggle-details-btn">
                  <mat-icon [class.rotate-180]="showConflictDetails">expand_more</mat-icon>
                </button>
              </div>
              <p class="text-sm text-orange-600 mt-1">{{ getCategoryHelpText('withConflicts') }}</p>
            </div>

            <div class="teacher-cards-grid">
              <!-- ✅ CAMBIAR: Quitar (click) y agregar cursor-not-allowed -->
              <div *ngFor="let teacher of groupedTeachers.withConflicts"
                   class="teacher-card conflict-card disabled-card">

                <div class="card-header">
                  <div class="teacher-info">
                    <h5 class="teacher-name">{{ teacher.fullName }}</h5>
                    <p class="teacher-email">{{ teacher.email }}</p>
                  </div>
                  <div class="status-badge conflict-badge">
                    <mat-icon>event_busy</mat-icon>
                    <span>{{ getStatusDescription(teacher.availabilityStatus) }}</span>
                  </div>
                </div>

                <div class="card-content">
                  <!-- Información básica -->
                  <div class="knowledge-areas">
                    <div class="area-tags">
            <span *ngFor="let area of teacher.knowledgeAreas; let last = last"
                  class="area-tag"
                  [class.highlight]="isMatchingKnowledgeArea(area)">
              {{ area.name }}{{ !last ? ',' : '' }}
            </span>
                    </div>
                  </div>

                  <!-- ✅ INFORMACIÓN DE CONFLICTOS -->
                  <div class="conflict-summary">
                    <div class="conflict-overview">
                      <mat-icon class="text-orange-600">info</mat-icon>
                      <span class="conflict-text">{{ getConflictSummary(teacher) }}</span>
                    </div>

                    <!-- Detalles expandibles de conflictos -->
                    <div *ngIf="showConflictDetails && teacher.conflictingClasses"
                         class="conflict-details">
                      <div *ngFor="let conflict of teacher.conflictingClasses"
                           class="conflict-item">
                        <div class="conflict-item-header">
                          <span class="course-name">{{ conflict.courseName }}</span>
                          <span class="group-name">{{ conflict.studentGroupName }}</span>
                        </div>
                        <div class="conflict-item-details">
                          <div class="time-info">
                            <mat-icon>schedule</mat-icon>
                            <span>{{ conflict.startTime }} - {{ conflict.endTime }}</span>
                          </div>
                          <div class="space-info">
                            <mat-icon>room</mat-icon>
                            <span>{{ conflict.learningSpaceName }}</span>
                          </div>
                          <div class="type-info">
                            <mat-icon>{{ conflict.sessionType === 'THEORY' ? 'menu_book' : 'science' }}</mat-icon>
                            <span>{{ conflict.sessionType === 'THEORY' ? 'Teórica' : 'Práctica' }}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- ✅ NUEVO: Botón para ver horario del grupo en conflicto -->
                  <div class="conflict-action">
                    <button
                      mat-stroked-button
                      color="warn"
                      (click)="handleTeacherConflict(teacher)"
                      class="w-full">
                      <mat-icon class="mr-2">visibility</mat-icon>
                      Ver horario en conflicto
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ✅ CATEGORÍA 3: Docentes No Disponibles (Colapsada por defecto) -->
          <mat-expansion-panel *ngIf="groupedTeachers.unavailable.length > 0 || groupedTeachers.noSchedule.length > 0"
                               class="unavailable-panel">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <div class="flex items-center space-x-2">
                  <mat-icon class="text-slate-500">info</mat-icon>
                  <span class="text-slate-700">No Disponibles ({{ groupedTeachers.unavailable.length + groupedTeachers.noSchedule.length }})</span>
                </div>
              </mat-panel-title>
              <mat-panel-description>
                Docentes que no pueden ser asignados en este horario
              </mat-panel-description>
            </mat-expansion-panel-header>

            <div class="unavailable-content">
              <!-- Docentes fuera de horario -->
              <div *ngIf="groupedTeachers.unavailable.length > 0" class="unavailable-group">
                <h5 class="group-title">Fuera de Horario de Disponibilidad</h5>
                <div class="teacher-list">
                  <div *ngFor="let teacher of groupedTeachers.unavailable" class="teacher-item unavailable-item">
                    <div class="teacher-basic-info">
                      <span class="teacher-name">{{ teacher.fullName }}</span>
                      <span class="teacher-status">{{ getStatusDescription(teacher.availabilityStatus) }}</span>
                    </div>
                    <div *ngIf="teacher.recommendedTimeSlots" class="recommended-times">
                      <mat-icon class="text-slate-400">schedule</mat-icon>
                      <span class="text-sm text-slate-600">Disponible: {{ teacher.recommendedTimeSlots }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Docentes sin horario configurado -->
              <div *ngIf="groupedTeachers.noSchedule.length > 0" class="unavailable-group">
                <h5 class="group-title">Sin Horario Configurado</h5>
                <div class="teacher-list">
                  <div *ngFor="let teacher of groupedTeachers.noSchedule" class="teacher-item no-schedule-item">
                    <div class="teacher-basic-info">
                      <span class="teacher-name">{{ teacher.fullName }}</span>
                      <span class="teacher-status">{{ getStatusDescription(teacher.availabilityStatus) }}</span>
                    </div>
                    <div class="no-schedule-help">
                      <mat-icon class="text-slate-400">help_outline</mat-icon>
                      <span class="text-sm text-slate-600">Debe configurar su horario de disponibilidad</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </mat-expansion-panel>

          <!-- ✅ ESTADO VACÍO: Sin docentes elegibles -->
          <div *ngIf="eligibleTeachersDetailed.length === 0" class="empty-state">
            <div class="empty-state-content">
              <mat-icon class="empty-icon">school</mat-icon>
              <h4 class="empty-title">No hay docentes elegibles</h4>
              <p class="empty-description">
                No se encontraron docentes con el área de conocimiento requerida para este curso.
              </p>
            </div>
          </div>
        </div>
      </div>
    </mat-expansion-panel>

    <!-- Step 4: Selección de Aula -->
    <mat-expansion-panel [expanded]="currentStep === 4"
                         [disabled]="!selectionState.teacher"
                         (opened)="currentStep = 4">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <span class="step-number">4</span>
          Seleccionar Aula
        </mat-panel-title>
        <mat-panel-description *ngIf="selectionState.learningSpace">
          {{ selectionState.learningSpace?.name }}
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="step-content">
        <!-- ✅ Mostrar el tipo de aula que se está buscando -->
        <div class="space-type-info" *ngIf="selectionState.selectedSessionType">
          <mat-icon [class]="selectionState.selectedSessionType === 'THEORY' ? 'theory-icon' : 'practice-icon'">
            {{ selectionState.selectedSessionType === 'THEORY' ? 'menu_book' : 'science' }}
          </mat-icon>
          <span>
            Buscando {{ selectionState.selectedSessionType === 'THEORY' ? 'aulas teóricas' : 'laboratorios' }}
            disponibles para sesión {{ selectionState.selectedSessionType === 'THEORY' ? 'teórica' : 'práctica' }}
          </span>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Aula/Laboratorio</mat-label>
          <mat-select formControlName="learningSpaceUuid" (selectionChange)="onSpaceSelected($event.value)">
            <mat-optgroup *ngFor="let group of groupedSpaces" [label]="group.label">
              <mat-option *ngFor="let space of group.spaces" [value]="space.uuid">
                <div class="option-content">
                  <span class="option-main">{{ space.name }}</span>
                  <span class="option-secondary">
                    Capacidad: {{ space.capacity }} -
                    {{ space.teachingType.name === 'THEORY' ? 'Teórica' : 'Práctica' }}
                    <span *ngIf="space.specialty"> - {{ space.specialty.name }}</span>
                  </span>
                </div>
              </mat-option>
            </mat-optgroup>
          </mat-select>
          <mat-hint *ngIf="loadingSpaces">
            <mat-spinner diameter="16"></mat-spinner>
            Verificando disponibilidad de {{ selectionState.selectedSessionType === 'THEORY' ? 'aulas' : 'laboratorios' }}...
          </mat-hint>
          <mat-hint *ngIf="!loadingSpaces && eligibleSpaces.length === 0 && selectionState.selectedSessionType">
            No hay {{ selectionState.selectedSessionType === 'THEORY' ? 'aulas teóricas' : 'laboratorios' }} disponibles en este horario
          </mat-hint>
        </mat-form-field>

        <!-- ✅ Información sobre especialidades preferidas -->
        <div class="specialty-info" *ngIf="selectionState.course?.preferredSpecialty && selectionState.selectedSessionType === 'PRACTICE'">
          <mat-icon>star</mat-icon>
          <div class="info-content">
            <strong>Laboratorio preferido:</strong> {{ selectionState.course?.preferredSpecialty?.name }}
            <p>Los laboratorios de esta especialidad aparecen primero en la lista</p>
          </div>
        </div>
      </div>
    </mat-expansion-panel>

    <!-- Step 5: Confirmación y Validación -->
    <mat-expansion-panel [expanded]="currentStep === 5"
                         [disabled]="!selectionState.learningSpace"
                         (opened)="currentStep = 5">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <span class="step-number">5</span>
          Confirmar Asignación
        </mat-panel-title>
      </mat-expansion-panel-header>

      <div class="step-content">
        <!-- Resumen de la asignación -->
        <div class="assignment-summary">
          <h4>Resumen de la Asignación</h4>
          <mat-list>
            <mat-list-item>
              <mat-icon matListItemIcon>book</mat-icon>
              <span matListItemTitle>{{ selectionState.course?.name }}</span>
            </mat-list-item>
            <mat-list-item>
              <mat-icon matListItemIcon [class]="selectionState.selectedSessionType === 'THEORY' ? 'theory-icon' : 'practice-icon'">
                {{ selectionState.selectedSessionType === 'THEORY' ? 'menu_book' : 'science' }}
              </mat-icon>
              <span matListItemTitle>
                Sesión {{ selectionState.selectedSessionType === 'THEORY' ? 'Teórica' : 'Práctica' }}
              </span>
            </mat-list-item>
            <mat-list-item>
              <mat-icon matListItemIcon>person</mat-icon>
              <span matListItemTitle>{{ selectionState.teacher?.fullName }}</span>
            </mat-list-item>
            <mat-list-item>
              <mat-icon matListItemIcon>room</mat-icon>
              <span matListItemTitle>{{ selectionState.learningSpace?.name }}</span>
            </mat-list-item>
            <mat-list-item>
              <mat-icon matListItemIcon>schedule</mat-icon>
              <span matListItemTitle>{{ formatTimeRange(data.teachingHours || []) }}</span>
            </mat-list-item>
          </mat-list>
        </div>

        <!-- Notas adicionales -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Notas (Opcional)</mat-label>
          <textarea matInput
                    formControlName="notes"
                    rows="3"
                    placeholder="Agregar observaciones o notas sobre esta clase...">
          </textarea>
        </mat-form-field>

        <!-- Validación en tiempo real -->
        <div class="validation-panel" *ngIf="validationResult">
          <div class="validation-section" *ngIf="validationResult.errors.length > 0">
            <h4 class="error-title">
              <mat-icon>error</mat-icon>
              Errores
            </h4>
            <mat-list>
              <mat-list-item *ngFor="let error of validationResult.errors">
                <mat-icon matListItemIcon color="warn">cancel</mat-icon>
                <span matListItemTitle>{{ error }}</span>
              </mat-list-item>
            </mat-list>
          </div>

          <div class="validation-section" *ngIf="validationResult.warnings.length > 0">
            <h4 class="warning-title">
              <mat-icon>warning</mat-icon>
              Advertencias
            </h4>
            <mat-list>
              <mat-list-item *ngFor="let warning of validationResult.warnings">
                <mat-icon matListItemIcon color="accent">warning</mat-icon>
                <span matListItemTitle>{{ warning }}</span>
              </mat-list-item>
            </mat-list>
          </div>

          <div class="validation-section" *ngIf="validationResult.suggestions.length > 0">
            <h4 class="suggestion-title">
              <mat-icon>lightbulb</mat-icon>
              Sugerencias
            </h4>
            <mat-list>
              <mat-list-item *ngFor="let suggestion of validationResult.suggestions">
                <mat-icon matListItemIcon>tips_and_updates</mat-icon>
                <span matListItemTitle>{{ suggestion }}</span>
              </mat-list-item>
            </mat-list>
          </div>
        </div>
      </div>
    </mat-expansion-panel>

  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()">Cancelar</button>
  <button mat-raised-button
          color="primary"
          (click)="onSave()"
          [disabled]="!canSave">
    <mat-spinner diameter="20" *ngIf="saving"></mat-spinner>
    {{ saving ? 'Guardando...' : (data.mode === 'create' ? 'Crear' : 'Actualizar') }}
  </button>
</mat-dialog-actions>
