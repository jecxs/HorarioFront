<!-- src/app/features/class-assignments/components/schedule-board/schedule-board.component.html -->
<div class="schedule-board-container">

  <!-- Header con controles principales -->
  <mat-card class="header-card">
    <mat-card-header>
      <div class="header-content">
        <div class="title-section">
          <mat-icon [color]="'primary'">{{ currentModeIcon }}</mat-icon>
          <h2>{{ currentModeLabel }}</h2>
          <mat-chip-set *ngIf="scheduleStatistics">
            <mat-chip color="primary">
              <mat-icon>schedule</mat-icon>
              {{ scheduleStatistics.totalSessions }} sesiones
            </mat-chip>
            <mat-chip [color]="conflictsCount > 0 ? 'warn' : 'accent'">
              <mat-icon>{{ conflictsCount > 0 ? 'warning' : 'check_circle' }}</mat-icon>
              {{ conflictsCount }} conflictos
            </mat-chip>
            <mat-chip color="accent">
              <mat-icon>pie_chart</mat-icon>
              {{ occupancyPercentage }}% ocupación
            </mat-chip>
          </mat-chip-set>
        </div>

        <div class="action-buttons">
          <button mat-raised-button color="primary" (click)="refreshData()" [disabled]="loading">
            <mat-icon>refresh</mat-icon>
            Actualizar
          </button>

          <button mat-stroked-button (click)="exportSchedule()">
            <mat-icon>download</mat-icon>
            Exportar
          </button>

          <button mat-stroked-button (click)="printSchedule()">
            <mat-icon>print</mat-icon>
            Imprimir
          </button>

          <button mat-icon-button [matMenuTriggerFor]="viewMenu" matTooltip="Opciones de vista">
            <mat-icon>more_vert</mat-icon>
          </button>
        </div>
      </div>
    </mat-card-header>

    <!-- Menú de opciones de vista -->
    <mat-menu #viewMenu="matMenu">
      <button mat-menu-item (click)="scheduleView.showConflicts = !scheduleView.showConflicts">
        <mat-icon>{{ scheduleView.showConflicts ? 'visibility' : 'visibility_off' }}</mat-icon>
        <span>{{ scheduleView.showConflicts ? 'Ocultar' : 'Mostrar' }} conflictos</span>
      </button>
      <button mat-menu-item (click)="scheduleView.showSuggestions = !scheduleView.showSuggestions">
        <mat-icon>{{ scheduleView.showSuggestions ? 'lightbulb' : 'lightbulb_outline' }}</mat-icon>
        <span>{{ scheduleView.showSuggestions ? 'Ocultar' : 'Mostrar' }} sugerencias</span>
      </button>
      <button mat-menu-item (click)="isIntelliSenseEnabled = !isIntelliSenseEnabled">
        <mat-icon>{{ isIntelliSenseEnabled ? 'psychology' : 'psychology_alt' }}</mat-icon>
        <span>{{ isIntelliSenseEnabled ? 'Desactivar' : 'Activar' }} IntelliSense</span>
      </button>
    </mat-menu>

    <!-- Controles de vista -->
    <mat-card-content>
      <form [formGroup]="viewForm" class="view-controls">
        <div class="control-row">
          <mat-form-field appearance="outline" class="mode-field">
            <mat-label>Modo de vista</mat-label>
            <mat-select formControlName="mode">
              <mat-option *ngFor="let mode of viewModes" [value]="mode.value">
                <mat-icon>{{ mode.icon }}</mat-icon>
                {{ mode.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="entity-field"
                          *ngIf="scheduleView.mode !== 'GLOBAL'">
            <mat-label>
              {{ scheduleView.mode === 'TEACHER' ? 'Docente' :
              scheduleView.mode === 'GROUP' ? 'Grupo' : 'Aula' }}
            </mat-label>
            <mat-select formControlName="selectedEntity">
              <mat-option *ngFor="let teacher of eligibleTeachers"
                          [value]="teacher"
                          *ngIf="scheduleView.mode === 'TEACHER'">
                {{ teacher.firstName }} {{ teacher.lastName }}
                <span class="teacher-areas">
                  - {{ teacher.knowledgeAreas?.map(area => area.name).join(', ') }}
                </span>
              </mat-option>
              <mat-option *ngFor="let group of studentGroups"
                          [value]="group"
                          *ngIf="scheduleView.mode === 'GROUP'">
                {{ group.name }} - {{ group.cycle.name }}
              </mat-option>
              <mat-option *ngFor="let space of eligibleSpaces"
                          [value]="space"
                          *ngIf="scheduleView.mode === 'SPACE'">
                {{ space.name }} ({{ space.capacity }} estudiantes)
              </mat-option>
            </mat-select>
          </mat-form-field>

          <div class="toggle-controls">
            <mat-slide-toggle formControlName="showConflicts" color="warn">
              <mat-icon>warning</mat-icon>
              Conflictos
            </mat-slide-toggle>

            <mat-slide-toggle formControlName="showSuggestions" color="accent">
              <mat-icon>lightbulb</mat-icon>
              Sugerencias
            </mat-slide-toggle>

            <mat-slide-toggle [(ngModel)]="isIntelliSenseEnabled" color="primary">
              <mat-icon>psychology</mat-icon>
              IntelliSense
            </mat-slide-toggle>
          </div>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Panel de asignación rápida -->
  <mat-card class="quick-assign-panel">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>flash_on</mat-icon>
        Asignación Rápida
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="quickAssignForm" class="quick-assign-form">
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Grupo</mat-label>
            <mat-select formControlName="group" required>
              <mat-option *ngFor="let group of studentGroups" [value]="group.uuid">
                <div class="group-option">
                  <div class="group-name">{{ group.name }}</div>
                  <div class="group-cycle">{{ group.cycle.name }} - {{ group.cycle.career.name }}</div>
                </div>
              </mat-option>
            </mat-select>
            <mat-hint>Seleccione el grupo de estudiantes</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Curso</mat-label>
            <mat-select formControlName="course" required>
              <mat-option *ngFor="let course of availableCourses" [value]="course.uuid">
                <div class="course-option">
                  <div class="course-code">{{ course.code }}</div>
                  <div class="course-name">{{ course.name }}</div>
                  <mat-chip-set>
                    <mat-chip [color]="getCourseTypeColor(course)" size="small">
                      {{ getCourseTypeText(course) }}
                    </mat-chip>
                    <mat-chip color="primary" size="small">
                      {{ course.totalWeeklyHours }}h/sem
                    </mat-chip>
                  </mat-chip-set>
                </div>
              </mat-option>
            </mat-select>
            <mat-hint>Curso a asignar</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Docente</mat-label>
            <mat-select formControlName="teacher" required>
              <mat-option *ngFor="let teacher of eligibleTeachers" [value]="teacher.uuid">
                <div class="teacher-option">
                  <div class="teacher-name">{{ teacher.firstName }} {{ teacher.lastName }}</div>
                  <div class="teacher-areas">
                    {{ teacher.knowledgeAreas?.map(area => area.name).join(', ') || 'Sin áreas asignadas' }}
                  </div>
                  <mat-chip-set>
                    <mat-chip color="accent" size="small">
                      {{ teacher.academicDepartment?.name || 'Sin departamento' }}
                    </mat-chip>
                  </mat-chip-set>
                </div>
              </mat-option>
            </mat-select>
            <mat-hint>Docente responsable</mat-hint>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Aula</mat-label>
            <mat-select formControlName="space" required>
              <mat-option *ngFor="let space of eligibleSpaces" [value]="space.uuid">
                <div class="space-option">
                  <div class="space-name">{{ space.name }}</div>
                  <div class="space-capacity">Capacidad: {{ space.capacity }} estudiantes</div>
                  <div class="space-specialty" *ngIf="space.specialty">
                    Especialidad: {{ space.specialty.name }}
                  </div>
                  <mat-chip-set>
                    <mat-chip [color]="space.teachingType?.name === 'PRACTICE' ? 'warn' : 'primary'" size="small">
                      {{ space.teachingType?.name === 'PRACTICE' ? 'Laboratorio' : 'Teórico' }}
                    </mat-chip>
                    <mat-chip color="accent" size="small" *ngIf="space.hasProjector">
                      <mat-icon fontIcon="videocam"></mat-icon>
                      Proyector
                    </mat-chip>
                    <mat-chip color="accent" size="small" *ngIf="space.hasComputers">
                      <mat-icon fontIcon="computer"></mat-icon>
                      PC
                    </mat-chip>
                  </mat-chip-set>
                </div>
              </mat-option>
            </mat-select>
            <mat-hint>Aula o laboratorio</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Día</mat-label>
            <mat-select formControlName="dayOfWeek" required>
              <mat-option *ngFor="let day of daysOfWeek" [value]="day">
                {{ dayLabels[day] }}
              </mat-option>
            </mat-select>
            <mat-hint>Día de la semana</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Turno</mat-label>
            <mat-select formControlName="timeSlot" required>
              <mat-option *ngFor="let timeSlot of timeSlots" [value]="timeSlot.uuid">
                <div class="timeslot-option">
                  <div class="slot-name">{{ timeSlot.name }}</div>
                  <div class="slot-time">
                    {{ timeSlot.startTime | slice:0:5 }} - {{ timeSlot.endTime | slice:0:5 }}
                  </div>
                </div>
              </mat-option>
            </mat-select>
            <mat-hint>Horario de clase</mat-hint>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field notes-field">
            <mat-label>Notas (opcional)</mat-label>
            <mat-input formControlName="notes" placeholder="Observaciones adicionales"></mat-input>
            <mat-hint>Información adicional sobre la asignación</mat-hint>
          </mat-form-field>

          <div class="assign-actions">
            <button mat-raised-button
                    color="primary"
                    type="button"
                    (click)="onQuickAssign()"
                    [disabled]="quickAssignForm.invalid || loading">
              <mat-icon>add_circle</mat-icon>
              Asignar
            </button>

            <button mat-stroked-button
                    type="button"
                    (click)="quickAssignForm.reset()">
              <mat-icon>clear</mat-icon>
              Limpiar
            </button>
          </div>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Grid principal del horario -->
  <mat-card class="schedule-grid-container">
    <mat-card-header>
      <mat-card-title>
        <div class="grid-header">
          <div class="grid-title">
            <mat-icon>calendar_view_week</mat-icon>
            Horario Semanal
          </div>
          <div class="grid-stats" *ngIf="scheduleStatistics">
            <mat-chip color="primary">{{ scheduleStatistics.totalHours }} horas totales</mat-chip>
            <mat-chip color="accent">{{ scheduleStatistics.teachersCount }} docentes</mat-chip>
            <mat-chip color="warn" *ngIf="conflictsCount > 0">{{ conflictsCount }} conflictos</mat-chip>
          </div>
        </div>
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <!-- Loading indicator -->
      <div class="loading-container" *ngIf="loading">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Cargando horario...</p>
      </div>

      <!-- Schedule grid -->
      <div class="schedule-grid" #scheduleGrid *ngIf="!loading && scheduleMatrix.length > 0">
        <!-- Header row with days -->
        <div class="grid-header-row">
          <div class="time-header">Horario</div>
          <div class="day-header" *ngFor="let day of daysOfWeek">
            {{ dayLabels[day] }}
          </div>
        </div>

        <!-- Schedule rows -->
        <div class="grid-row" *ngFor="let row of scheduleMatrix; let i = index">
          <!-- Time column -->
          <div class="time-column">
            <div class="time-slot-info">
              <div class="time-range">
                {{ row[0].teachingHour.startTime | slice:0:5 }} -
                {{ row[0].teachingHour.endTime | slice:0:5 }}
              </div>
              <div class="time-slot-name">{{ row[0].timeSlot.name }}</div>
            </div>
          </div>

          <!-- Schedule cells -->
          <div class="schedule-cell-container" *ngFor="let cell of row; let j = index">
            <div
              class="schedule-cell"
              [ngClass]="getCellClasses(cell)"
              [matTooltip]="getCellTooltip(cell)"
              matTooltipPosition="above"
              [matTooltipDisabled]="!scheduleView.showSuggestions"
              (click)="onCellClick(cell)"
              (mouseenter)="onCellHover(cell)"
              (mouseleave)="onCellLeave()"
              (contextmenu)="onCellSelect(cell, $event)"
              cdkDrag
              [cdkDragData]="cell.session"
              [cdkDragDisabled]="!cell.session"
              (cdkDragStarted)="onSessionDragStart(cell.session!)"
              cdkDropList
              (cdkDropListDropped)="onCellDrop($event, cell)">

              <!-- Contenido de celda vacía -->
              <div class="empty-cell" *ngIf="!cell.session">
                <div class="cell-time">
                  {{ cell.teachingHour.startTime | slice:0:5 }}
                </div>

                <!-- IntelliSense indicators -->
                <div class="intellisense-indicators" *ngIf="isIntelliSenseEnabled && cell.intelliSenseData">
                  <mat-icon class="available-icon"
                            *ngIf="cell.intelliSenseData.eligibleTeachers.length > 0"
                            [matBadge]="cell.intelliSenseData.eligibleTeachers.length"
                            matBadgeSize="small">
                    person
                  </mat-icon>
                  <mat-icon class="space-icon"
                            *ngIf="cell.intelliSenseData.eligibleSpaces.length > 0"
                            [matBadge]="cell.intelliSenseData.eligibleSpaces.length"
                            matBadgeSize="small">
                    room
                  </mat-icon>
                </div>

                <!-- Suggestions indicator -->
                <mat-icon class="suggestion-icon"
                          *ngIf="scheduleView.showSuggestions && cell.suggestions.length > 0"
                          [matBadge]="cell.suggestions.length"
                          matBadgeSize="small"
                          color="accent">
                  lightbulb
                </mat-icon>
              </div>

              <!-- Contenido de celda ocupada -->
              <div class="session-cell" *ngIf="cell.session">
                <div class="session-header">
                  <div class="course-code">{{ cell.session.course.code }}</div>
                  <div class="session-actions">
                    <button mat-icon-button
                            size="small"
                            (click)="editSession(cell.session!); $event.stopPropagation()"
                            matTooltip="Editar sesión">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-icon-button
                            size="small"
                            color="warn"
                            (click)="deleteSession(cell.session!, $event)"
                            matTooltip="Eliminar sesión">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>

                <div class="session-content">
                  <div class="course-name">{{ cell.session.course.name }}</div>
                  <div class="teacher-name">{{ cell.session.teacher.lastName }}</div>
                  <div class="space-info">{{ cell.session.learningSpace.name }}</div>
                  <div class="group-info">{{ cell.session.studentGroup.name }}</div>

                  <!-- Session type indicator -->
                  <mat-chip class="session-type-chip"
                            [color]="cell.session.sessionType.name === 'PRACTICE' ? 'warn' : 'primary'"
                            size="small">
                    <mat-icon>{{ cell.session.sessionType.name === 'PRACTICE' ? 'science' : 'menu_book' }}</mat-icon>
                    {{ cell.session.sessionType.name === 'PRACTICE' ? 'Práctica' : 'Teoría' }}
                  </mat-chip>
                </div>

                <!-- Conflict indicator -->
                <app-conflict-indicator
                  *ngIf="scheduleView.showConflicts && cell.hasConflict"
                  class="conflict-indicator">
                </app-conflict-indicator>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty state -->
      <div class="empty-state" *ngIf="!loading && scheduleMatrix.length === 0">
        <mat-icon>calendar_month</mat-icon>
        <h3>No hay datos de horario</h3>
        <p>Configure los turnos y horas pedagógicas para comenzar</p>
        <button mat-raised-button color="primary" (click)="refreshData()">
          <mat-icon>refresh</mat-icon>
          Recargar datos
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Panel de estadísticas -->
  <mat-card class="statistics-panel" *ngIf="scheduleStatistics">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>analytics</mat-icon>
        Estadísticas del Horario
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <div class="stats-grid">
        <div class="stat-item">
          <mat-icon color="primary">schedule</mat-icon>
          <div class="stat-content">
            <div class="stat-value">{{ scheduleStatistics.totalSessions }}</div>
            <div class="stat-label">Sesiones totales</div>
          </div>
        </div>

        <div class="stat-item">
          <mat-icon color="accent">access_time</mat-icon>
          <div class="stat-content">
            <div class="stat-value">{{ scheduleStatistics.totalHours }}</div>
            <div class="stat-label">Horas semanales</div>
          </div>
        </div>

        <div class="stat-item">
          <mat-icon color="primary">person</mat-icon>
          <div class="stat-content">
            <div class="stat-value">{{ scheduleStatistics.teachersCount }}</div>
            <div class="stat-label">Docentes activos</div>
          </div>
        </div>

        <div class="stat-item">
          <mat-icon color="accent">room</mat-icon>
          <div class="stat-content">
            <div class="stat-value">{{ scheduleStatistics.spacesCount }}</div>
            <div class="stat-label">Aulas utilizadas</div>
          </div>
        </div>

        <div class="stat-item">
          <mat-icon color="primary">group</mat-icon>
          <div class="stat-content">
            <div class="stat-value">{{ scheduleStatistics.groupsCount }}</div>
            <div class="stat-label">Grupos activos</div>
          </div>
        </div>

        <div class="stat-item">
          <mat-icon [color]="conflictsCount > 0 ? 'warn' : 'accent'">
            {{ conflictsCount > 0 ? 'warning' : 'check_circle' }}
          </mat-icon>
          <div class="stat-content">
            <div class="stat-value">{{ conflictsCount }}</div>
            <div class="stat-label">Conflictos</div>
          </div>
        </div>
      </div>

      <!-- Distribution charts -->
      <div class="distribution-charts" *ngIf="scheduleStatistics.theoryPercentage || scheduleStatistics.practicePercentage">
        <h4>Distribución de horas</h4>
        <div class="chart-item">
          <span>Teoría:</span>
          <div class="progress-bar">
            <div class="progress-fill theory"
                 [style.width.%]="scheduleStatistics.theoryPercentage">
            </div>
          </div>
          <span>{{ scheduleStatistics.theoryPercentage | number:'1.1-1' }}%</span>
        </div>
        <div class="chart-item">
          <span>Práctica:</span>
          <div class="progress-bar">
            <div class="progress-fill practice"
                 [style.width.%]="scheduleStatistics.practicePercentage">
            </div>
          </div>
          <span>{{ scheduleStatistics.practicePercentage | number:'1.1-1' }}%</span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

</div>
